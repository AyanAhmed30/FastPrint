name: 🚀 Deploy Backend to EC2

on:
  push:
    branches:
      - main  # or your deployment branch

jobs:
  deploy:
    name: Deploy FastPrint Backend
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v4

      - name: 📦 Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: 🚀 Deploy Backend with Unified Script
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            set -e  # Exit on any error
            
            echo "🚀 Starting Backend Deployment..."
            
            # Check if backend directory exists
            BACKEND_DIR="$HOME/FastPrint"
            if [ ! -d "$BACKEND_DIR" ]; then
              echo "❌ Backend directory not found at $BACKEND_DIR"
              echo "📁 Available directories in home:"
              ls -la $HOME/
              exit 1
            fi
            
            cd "$BACKEND_DIR"
            echo "📍 Current directory: $(pwd)"
            
            # Pull latest changes including the unified deployment script
            echo "📥 Pulling latest changes..."
            git pull origin main
            
            # Make sure the deployment script is executable
            chmod +x deploy-unified.sh
            
            # Run unified deployment for backend only
            echo "🔧 Running unified deployment script..."
            ./deploy-unified.sh --backend-only
          EOF

      - name: ✅ Validate Backend Deployment
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            # Wait a moment for services to stabilize
            sleep 10
            
            # Check if backend container is running
            if ! docker-compose -f ~/FastPrint/docker-compose.yml ps | grep -q "backend.*Up"; then
              echo "❌ Backend container is not running"
              docker-compose -f ~/FastPrint/docker-compose.yml logs backend
              exit 1
            fi
            
            # Check if backend is responding
            if ! curl -f http://localhost:8000/admin/ > /dev/null 2>&1; then
              echo "❌ Backend is not responding on port 8000"
              docker-compose -f ~/FastPrint/docker-compose.yml logs backend
              exit 1
            fi
            
            # Check if backend is accessible through Nginx (if SSL is configured)
            if curl -f https://app.fastprintguys.com/api/admin/ > /dev/null 2>&1; then
              echo "✅ Backend is accessible through Nginx with HTTPS"
            elif curl -f http://app.fastprintguys.com/api/admin/ > /dev/null 2>&1; then
              echo "✅ Backend is accessible through Nginx with HTTP"
            else
              echo "⚠️ Backend may not be accessible through Nginx - check configuration"
            fi
            
            echo "✅ Backend deployment validation completed"
          EOF
